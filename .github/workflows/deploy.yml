name: Deploy to Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'Dev'
        type: choice
        options:
          - Dev
          - Staging
          - Production

jobs:
  deploy:
    runs-on: self-hosted

    env:
      COMPOSE_FILE: deploy/docker-compose.${{ github.event.inputs.environment }}.yml

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Pull latest OrderService image
      run: docker pull majidebadiparsajob/orderservice:latest

    - name: Pull latest InventoryService image
      run: docker pull majidebadiparsajob/inventoryservice:latest

    - name: Clean previous containers
      run: docker-compose -f %COMPOSE_FILE% down
      continue-on-error: true

    - name: Deploy using docker-compose
      run: docker-compose -f %COMPOSE_FILE% up -d
