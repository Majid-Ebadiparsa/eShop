name: Deploy to Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'Dev'
        type: choice
        options:
          - Dev
          - Staging
          - Production

jobs:
  deploy:
    runs-on: self-hosted

    env:
      COMPOSE_FILE: deploy/docker-compose.${{ github.event.inputs.environment }}.yml

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Pull latest OrderService image
      run: docker pull majidebadiparsajob/orderservice:latest

    - name: Pull latest InventoryService image
      run: docker pull majidebadiparsajob/inventoryservice:latest

    - name: Clean previous containers
      shell: pwsh
      run: |
        try {
          docker-compose -f $env:COMPOSE_FILE down
        } catch {
          Write-Host "Ignoring error"
        }

    - name: Deploy using docker-compose
      run: docker-compose -f $env:COMPOSE_FILE up -d
