name: DeliveryService - Pipeline

on:
  pull_request:
    paths:
      - 'DeliveryService/**'
      - '.github/workflows/deliveryservice.yml'
  push:
    branches: [ "main", "develop", "feature/**" ]
    paths:
      - 'DeliveryService/**'
      - '.github/workflows/deliveryservice.yml'
  workflow_dispatch:
    inputs:
      deploy_prod:
        description: "Deploy to Production (true/false)"
        required: false
        default: "false"
        type: choice
        options: ["false","true"]
      prod_tag:
        description: "Optional image tag (short SHA). Empty = last main commit"
        required: false
        type: string

concurrency:
  group: deliveryservice-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

env:
  SERVICE_NAME: deliveryservice
  SLN: Delivery.sln
  DOCKER_IMAGE: majidebadiparsajob/deliveryservice

jobs:
# ---------- Build & Test on PR and Push (all target branches) ----------
  build_test:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      sha_short: ${{ steps.meta.outputs.sha_short }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Derive short SHA
        id: meta
        run: echo "sha_short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore ${{ env.SLN }}

      - name: Build
        run: dotnet build ${{ env.SLN }} --no-restore -c Release

      - name: Test
        run: dotnet test ${{ env.SLN }} --no-build -c Release --logger "trx;LogFileName=${{ env.SERVICE_NAME }}-tests.trx"

      - name: Publish test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SERVICE_NAME }}-test-results
          path: '**/*.trx'

# ---------- Build EF Migration Bundle only on develop/main pushes ----------
  ef_bundle:
    name: Build EF Migration Bundle
    runs-on: ubuntu-latest
    needs: [ build_test ]
    if: |
          github.event_name == 'push' &&
          (startsWith(github.ref, 'refs/heads/develop') || startsWith(github.ref, 'refs/heads/main'))
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '10.0.x' }

      - name: Restore local tools
        run: dotnet tool restore

      - name: Restore solution
        run: dotnet restore ${{ env.SLN }}

      - name: Build solution (Release)
        run: dotnet build ${{ env.SLN }} -c Release --no-restore

      - name: Build idempotent bundle
        run: |
          dotnet ef migrations bundle \
            --project DeliveryService/DeliveryService.Infrastructure/DeliveryService.Infrastructure.csproj \
            --startup-project DeliveryService/DeliveryService.API/DeliveryService.API.csproj \
            --output ${{ env.SERVICE_NAME }}-migrations

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SERVICE_NAME }}-migrations-bundle
          path: ${{ env.SERVICE_NAME }}-migrations

# ---------- Docker Build & Publish on every push (feature/develop/main) ----------
  docker_publish:
    name: Docker Build & Publish
    runs-on: ubuntu-latest
    needs: [ build_test ]
    if: github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Derive short SHA
        id: meta
        run: echo "sha_short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Compute tags (per-branch policy)
        id: vars
        shell: bash
        run: |
          SHA="${{ steps.meta.outputs.sha_short }}"
          # Full branch name with slashes (e.g., feature/add-xyz)
          BRANCH="${GITHUB_REF_NAME}"

          # sanitize branch for tag usage (replace slashes/spaces with dashes)
          SLUG=$(echo "$BRANCH" | tr '/ .' '---')

          if [[ "$BRANCH" == "main" ]]; then
            TAGS="${{ env.DOCKER_IMAGE }}:main,${{ env.DOCKER_IMAGE }}:latest,${{ env.DOCKER_IMAGE }}:sha-$SHA"
          elif [[ "$BRANCH" == "develop" ]]; then
            TAGS="${{ env.DOCKER_IMAGE }}:develop,${{ env.DOCKER_IMAGE }}:sha-$SHA"
          elif [[ "$BRANCH" == feature/* ]]; then
            # If this push belongs to a PR you can also add pr-<number>, else fall back to branch-<slug>
            if [[ -n "${{ github.event.pull_request.number }}" ]]; then
              TAGS="${{ env.DOCKER_IMAGE }}:pr-${{ github.event.pull_request.number }},${{ env.DOCKER_IMAGE }}:sha-$SHA"
            else
              TAGS="${{ env.DOCKER_IMAGE }}:branch-$SLUG,${{ env.DOCKER_IMAGE }}:sha-$SHA"
            fi
          else
            TAGS="${{ env.DOCKER_IMAGE }}:sha-$SHA"
          fi

          echo "TAGS=$TAGS"
          echo "TAGS=$TAGS" >> $GITHUB_ENV


      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: DeliveryService/DeliveryService.API/Dockerfile
          push: true
          # build-push-action accepts comma-separated tags list
          tags: ${{ env.TAGS }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:latest
          cache-to: type=inline


  # ---------- Deploy to Staging only when pushing develop ----------
  deploy_staging:
    name: Deploy to Staging
    runs-on: self-hosted
    environment: staging
    needs: [ docker_publish, ef_bundle ]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download EF bundle
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.SERVICE_NAME }}-migrations-bundle
          path: ./artifacts/${{ env.SERVICE_NAME }}

      - name: Create .env (staging)
        shell: pwsh
        run: |
          $vals = [ordered]@{
          SQLSERVER_SA_PASSWORD        = "${{ secrets.SQLSERVER_SA_PASSWORD }}"
          ORDERDB_CONNECTIONSTRING     = "${{ secrets.ORDERDB_CONNECTIONSTRING }}"
          INVENTORYDB_CONNECTIONSTRING = "${{ secrets.INVENTORYDB_CONNECTIONSTRING }}"
          DELIVERYDB_CONNECTIONSTRING  = "${{ secrets.DELIVERYDB_CONNECTIONSTRING }}"
          RABBITMQ_USERNAME            = "${{ secrets.RABBITMQ_USERNAME }}"
          RABBITMQ_PASSWORD            = "${{ secrets.RABBITMQ_PASSWORD }}"
          RABBITMQ_VIRTUALHOST         = "${{ secrets.RABBITMQ_VIRTUALHOST }}"
          RABBITMQ_ORDERRECEIVEENDPOINT     = "${{ secrets.RABBITMQ_ORDERRECEIVEENDPOINT }}"
          RABBITMQ_INVENTORYRECEIVEENDPOINT = "${{ secrets.RABBITMQ_INVENTORYRECEIVEENDPOINT }}"
          RABBITMQ_DELIVERYRECEIVEENDPOINT  = "${{ secrets.RABBITMQ_DELIVERYRECEIVEENDPOINT }}"
          ORDERSERVICE_IMAGE           = "majidebadiparsajob/orderservice:develop"
          INVENTORYSERVICE_IMAGE       = "majidebadiparsajob/inventoryservice:develop"
          DELIVERYSERVICE_IMAGE        = "${{ env.DOCKER_IMAGE }}:develop"
          }

          # Detect missing/empty values
          $missing = @()
          foreach ($k in $vals.Keys) {
            if ([string]::IsNullOrWhiteSpace($vals[$k])) { $missing += $k }
          }
          if ($missing.Count -gt 0) {
            Write-Error ("Missing required secrets/env: " + ($missing -join ", "))
            exit 1
          }

          # Build .env content (line-delimited KEY=VALUE)
          $content = ($vals.GetEnumerator() | ForEach-Object { "$($_.Key)=$($_.Value)" }) -join "`n"
          Set-Content -Path ".env" -Value $content -NoNewline


      - name: Run EF bundle (Delivery DB)
        env:
          ConnectionStrings__DeliveryDb: ${{ secrets.DELIVERYDB_CONNECTIONSTRING }}
        run: |
          chmod +x ./artifacts/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}-migrations
          ./artifacts/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}-migrations

      - name: Compose Up (staging)
        run: |
          docker network inspect eshop_eshopnetwork >/dev/null 2>&1 || docker network create eshop_eshopnetwork
          docker compose --env-file .env -f deploy/docker-compose.staging.yml pull
          docker compose --env-file .env -f deploy/docker-compose.staging.yml up -d deliveryservice

# ---------- Manual Production deploy (from main images) ----------
  deploy_production:
    name: Deploy to Production (manual)
    runs-on: ubuntu-latest
    environment:
      name: production
    needs: [ docker_publish, ef_bundle ]
    if: github.event_name == 'workflow_dispatch' && inputs.deploy_prod == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Resolve tag
        id: tag
        run: |
          TAG="${{ inputs.prod_tag }}"
          if [ -z "$TAG" ]; then
            TAG="${GITHUB_SHA::7}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Download EF bundle
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.SERVICE_NAME }}-migrations-bundle
          path: ./artifacts/${{ env.SERVICE_NAME }}

      - name: Create .env (prod)
        run: |
          cat > .env <<EOF
          SQLSERVER_SA_PASSWORD=${{ secrets.PROD_SQLSERVER_SA_PASSWORD }}
          ORDERDB_CONNECTIONSTRING=${{ secrets.PROD_ORDERDB_CONNECTIONSTRING }}
          INVENTORYDB_CONNECTIONSTRING=${{ secrets.PROD_INVENTORYDB_CONNECTIONSTRING }}
          DELIVERYDB_CONNECTIONSTRING=${{ secrets.PROD_DELIVERYDB_CONNECTIONSTRING }}
          RABBITMQ_USERNAME=${{ secrets.PROD_RABBITMQ_USERNAME }}
          RABBITMQ_PASSWORD=${{ secrets.PROD_RABBITMQ_PASSWORD }}
          RABBITMQ_VIRTUALHOST=${{ secrets.PROD_RABBITMQ_VIRTUALHOST }}
          RABBITMQ_ORDERRECEIVEENDPOINT=${{ secrets.PROD_RABBITMQ_ORDERRECEIVEENDPOINT }}
          RABBITMQ_INVENTORYRECEIVEENDPOINT=${{ secrets.PROD_INVENTORYRECEIVEENDPOINT }}
          RABBITMQ_DELIVERYRECEIVEENDPOINT=${{ secrets.PROD_DELIVERYRECEIVEENDPOINT }}
          ORDERSERVICE_IMAGE=majidebadiparsajob/orderservice:sha-<LAST_GOOD_SHA>
          INVENTORYSERVICE_IMAGE=majidebadiparsajob/inventoryservice:sha-<LAST_GOOD_SHA>
          DELIVERYSERVICE_IMAGE=${{ env.DOCKER_IMAGE }}:sha-${{ steps.tag.outputs.tag }}
          EOF

      - name: Run EF bundle (Delivery DB - prod)
        env:
          ConnectionStrings__DeliveryDb: ${{ secrets.PROD_DELIVERYDB_CONNECTIONSTRING }}
        run: |
          chmod +x ./artifacts/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}-migrations
          ./artifacts/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}-migrations

      - name: Compose Up (prod)
        run: |
          docker network inspect eshop_eshopnetwork >/dev/null 2>&1 || docker network create eshop_eshopnetwork
          docker compose --env-file .env -f deploy/docker-compose.production.yml pull
          docker compose --env-file .env -f deploy/docker-compose.production.yml up -d deliveryservice
